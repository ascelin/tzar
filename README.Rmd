---
output:
  md_document:
    variant: markdown_github
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```
# tzar

This package encapsulates R-related code for using the tzar code-running tool to manage doing lots of experiments.  tzar itself is documented at and downloadable from https://tzar-framework.atlassian.net/wiki/display/TD/Tzar+documentation.

The code in the tzar R package is primarily the R code required for emulating running tzar so that you get the tzar setup, file naming, and parameter file building without fully running tzar.  This allows you to run your code inside of R or RStudio in a way that allows you to do debugging, which is difficult or impossible to do when tzar has control of the entire process, e.g., on a remote machine.  

Note that in the explanations below, there are quite a few small things that 
you have to pay attention to, but they are primarily things that you do one 
time for your project and after that, everything happens behind the scenes. 
Your use of tzar emulation is then reduced to a single call such as ```runtip()``` 
or ```runtop()```.  Those functions are explained below.

## Installation  
You can install the R package for running tzar from within R using the following commands which retrieve the package from github:  
```R
# install.packages ("devtools")  
devtools::install_github ("langfob/tzar")
```

## Debugging  
#### model.R
No matter what problem you're having while using tzar emulation, look first to see if R/model.R exists.  If it does, then delete it and retry whatever you're doing (e.g., running runtip() or doing a Build, etc.)  The presence of model.R (instead of having it built automatically from model.R.tzar) seems to cause all kinds of strange errors whose messages make no mention at all of model.R and lead you astray.

#### No repetitions - Only single model runs are allowed under emulation
The emulator only allows single runs of the model because it's giving control 
back to the single R process that called it.  You should not have multiple 
repetitions invoked in a tzar yaml file's *repetitions* section during 
emulation.  

## runtip() and runtop() and run_tzar()
run_tzar() is the function that you call to do the work of running your code 
under tzar emulation, however, it's generally easier to do it using one of the 
two helper functions, runtip() and runtop().  Here's why as well as an 
explanation of which of those two to choose.  

####  runtip() and tzar emulation inside a package
When tzar runs, it needs to find and run a file called model.R and that file 
is where you have some or all of your program's code or make calls to 
elements of that code.  The only problem with this is that if you are building 
a package, R runs every ".R" file in the R directory of the package, including 
"model.R".  Since that code runs a model, you don't want it to be called when 
R is building a package (e.g., when/if CRAN is building your package).  

One way to get around this is to rename model.R to something else and then copy 
that file into a new model.R when tzar emulation is run.  That is what the 
function runtip() does.  First it does the copy and then it calls run_tzar() 
for you with the appropriate arguments.  "runtip" stands for "run tzar 
emulation inside a package".  

Because there are various parts of this process 
that are specific to your program, runtip() is provided as a template that you 
must modify.  The template code is in the file inst/templates/tzar_main.R.  You 
copy that file into your R area and modify that copy of the file to fit your 
project.  That file will then be the one that is run by R when it builds the 
package.  

####  runtop() and tzar emulation outside a package
If you are not building a package (and therefore, R is not automatically 
running every ".R" file in your code directory), then you don't have to worry 
about renaming the "model.R" file to hide it.  Instead, you can have your 
model.R file in with your other R code and you can run tzar 
emulation by calling run_top() instead of run_tip().  The runtop() function 
is also templated in the inst/templates/tzar_main.R file and you need to 
modify it in the copy of tzar_main.R inside your R code directory just as 
you would have modified the runtip() function.  Similarly, you could just 
use run_tzar() directly if you prefer.  runtop() is just a convenience function. 

####  Running tzar without emulation
Once you have your code ready to a point where you no longer want to run 
emulation, then you no longer run runtip() or runtop() or run_tzar().  You 
just run tzar with the usual tzar command line invocation under java.

## Simple example  
After you have edited the runtip() and/or runtop() functions for your program 
and loaded whatever libraries you need for your program, 
you just call runtip() or runtop().

```R
library (someLibrary)
runtip()
```

##  The basic idea behind the emulator (for experienced tzar users)

The basic idea is that running tzar with an empty model.R produces all the same setup as running with a model.R that calls your application code.  Consequently, you could run tzar with an empty model.R, go look for the most recent directory that tzar had created, then load the parameters.R file from that directory.  At that point, you could run your own application code with the newly loaded parameters list and it would be nearly indistinguishable from running your code under tzar but you would have control of your code for debugging, etc.  The emulator just automatically manages the finding, loading, and running for you.  It also manages a few other details of directory naming to indicate that a job ran and/or failed under emulation.

##  SUMMARY:  User steps required to enable tzar emulation

For each project that uses tzar emulation, you will need to do the steps below, once at the start of the project. There are a few of these steps but they are all pretty simple.  
- The reason for all this is that the whole process is a complete hack aimed at deceiving tzar into doing what we want.  There has been talk of adding a "dry run" option to tzar to properly do what this hack does, but so far, it's just talk.  In the meantime, this hack works.

###  The basic idea

- **Once for each project** where you want to use tzar emulation:
    - **Copy the *tzar_main* and *model* template files** from the tzar package
    - **Edit the *model* template** if necessary
    - **Edit the *tzar_main* template** to match your project's directories, etc.
    - Make sure that the **_tzar package_ is loaded**.
    - Make sure that you have a **_project.yaml_ file in the projectPath directory**.   
- **Each time you want to run tzar or tzar emulation** on that project:
    - **Call runtip() or runtop()** at command line

###  Details of each step

- **Copy the R template files** from the package into the R source code area where you want to work.
    - In the code below, replace *YOUR_R_WORKING_AREA* with the location of the R code for your project.
    - Also, note that *get_tzar_R_templates()* has two arguments that you can modify if you need to, i.e., the target directory and a flag indicating whether model.R should be renamed to model.R.tzar or left as model.R.  It never hurts to leave the flag set to the default value of TRUE because that will never accidentally overwrite a model.R file that you may have already created in your work area.

```{R eval=FALSE}
library (tzar)
get_tzar_R_templates ("YOUR_R_WORKING_AREA")
```

- **Edit model.R (or model.R.tzar if that's what was copied in)**
    - If building a package, **load your package** in model.R
        - Uncomment "#library (YOUR_PKG_NAME)"
        - Replace YOUR_PKG_NAME with the name of your package
    - **Set the following arguments** of the function called **in model.R** if their default values are not appropriate for your project.  In most cases, you shouldn't need to change their default values, particularly when you are first learning how to use tzar emulation.
        - main_function
        - projectPath
        - emulation_scratch_file_path

- **Edit tzar_main.R**
    - **Replace the dummy code in the tzar_main() function** with code appropriate to your project.
        - For the first test of using tzar emulation in your project, you probably want to just leave the dummy code there and make sure that the tzar call works and echoes the values from the project.yaml file.
        - Subsequently, tzar_main() will probably just contain a single call to the main function of your project with the parameters list as the only argument.
    - **Edit arguments to calls in runtip() and/or runtop()** to match your project.
        - runtip() and runtop() are convenience functions to allow you to quickly run tzar emulation at the command line without having to constantly retype long lists of arguments that are nearly always the same within a given project.
            - runt**i**p() is the function for working INSIDE building a package
            - runt**o**p() is the function for working OUTSIDE building a package, i.e., when just doing normal R development.
            - If you're building a package, then you won't even need the runtop() function in that project so you can even delete or ignore the runt**o**p() function.  
            - Similarly, if you're not building a package and expect to never try to turn the code you're working on into a package, then you won't need runt**i**p() and can delete or ignore it.
        - The arguments for runtip() and runtop() are listed below and are the same for both functions.  Bold arguments are the ones whose default values probably need to be replaced.  The others can be modified but probably don't need to be:
            - emulating_tzar
            - main_function
            - **project_path** (e.g., "~/mypkg/R")
            - emulation_scratch_file_path
            - **tzar_jar_path** (e.g., "~/myTzarJarDir/tzar.jar")
            - copy_model_R_tzar_file
            - model_R_tzar_src_dir
            - model_R_tzar_disguised_filename
            - overwrite_existing_model_R_dest
                - If you're inexperienced with the emulator, it's best to leave this set to the default value of FALSE.  Details about this flag are given in a separate note below.
            - required_model_R_filename_for_tzar
   
- Make sure that the **tzar package is loaded** for your code.  
    - If just running normal R code, then including "library(tzar)" somewhere works.
    - If building a package, then you need to include tzar in your Suggests or Depends in your package's DESCRIPTION file.  
        - If you're only using tzar while building the package and a user of your package would not use tzar, then it can just be in the Suggests instead of in the Depends.  

- Make sure that you have a **project.yaml file in the projectPath directory**.   
    - This is a tzar requirement and not specific to tzar emulation.
    - **When running emulation** rather than normal tzar, make sure that the **project.yaml file is only doing a single run** rather than using tzar's ability to generate lots of runs (e.g., with a repetitions section).  
        - If you were to generate multiple runs, there would be ambiguity because there would be more than one place to look for the parameters.R file that tzar generates.
        
- After all of that setup is done, each time you want to do a run of your application code under tzar or tzar emulation:
    - Call runtip() at the R command prompt if you're running as part of developing a package
    - Call runtop() at the R command prompt if you're running normal R code that is outside of developing a package.

------------------------------------------------------------

####  Details about the *overwrite_existing_model_R_dest* in runtip() and runtop() calls

The *overwrite_existing_model_R_dest* flag in calls to runtip() and runtop() is primarily there as a precaution to make sure that tzar emulation doesn't overwrite some existing version of model.R that you might have built in your R directory before starting to use tzar emulation.  This is necessary because the emulator may be copying model.R.tzar into model.R and that could destroy your existing work if you've already built a model.R file.  If you do have an existing model.R with contents you want included in tzar emulation, you'll have to combine the contents of your model.R and the template model.R to make sure that the emulator also has what it needs.  

In general, the safest thing to do is to leave this flag as FALSE.  However, in the early stages of developing a package your code may crash in ways that mean the emulator never gets to clean up after itself.  In that case, its copied version of model.R from the previous run might still be left in the R directory when the copy from model.R.tzar tries to take place and the attempted overwrite will throw an error, even though it's not really an error in this case.  It's just being extra cautious not to destroy work you may have done that it didn't know about.  

If you do get this error about attempting to overwrite model.R and it's just the leftover model.R from a previous copy, you just have to delete the old model.R and this will let the emulator copy the model.R.tzar into model.R.  If the *overwrite_existing_model_R_dest* flag is set to TRUE instead of FALSE, then model.R will always be overwritten and you won't have to worry about any of this but it won't be defaulting to the safest behavior.  

If you're working in a package and have only been working on model.R.tzar with the emulator copying it each time into model.R with no separate model.R of your own, then this is no problem.  Setting *overwrite_existing_model_R_dest* to TRUE is fine in that case and will save you from having to delete the old model.R when your code has crashes severe enough to not allow the emulator to clean up after itself.  This should be rare though.

## Common problems and corresponding fixes

- "cyclic namespace dependency" error when doing a package build after a model run that crashed
    - This seems to happen when 
        - the emulator is creating model.R by copying model.R.tzar before each run and 
        - the previous run crashed without cleaning up and deleting the model.R file
    - It's unclear why this leads to the build problem, but the solution seems to be to just delete the model.R file and try the build again.
    

